<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur Flashcards ‚Äì Version Avanc√©e</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; }
        body {
            background: linear-gradient(135deg, #2C75FF, #002FA7);
            min-height:100vh; padding:20px; color:white;
        }
        .main-layout {
            max-width:1200px; margin:0 auto;
            display:grid; grid-template-columns:1fr 1fr; gap:24px;
        }
        .container, .preview-container {
            background:rgba(255,255,255,0.09);
            backdrop-filter:blur(12px);
            border:1px solid rgba(255,255,255,0.18);
            border-radius:20px; padding:24px;
            box-shadow:0 14px 32px rgba(0,0,0,0.25);
        }
        h1 { text-align:center; margin-bottom:24px; grid-column:1/-1; text-shadow:0 2px 6px rgba(0,0,0,0.3); }
        label { display:block; margin:16px 0 6px; font-weight:bold; font-size:0.95em; text-transform:uppercase; letter-spacing:1px; }
        input, textarea {
            width:100%; padding:14px; border-radius:10px; border:none;
            font-size:15px; background:rgba(255,255,255,0.93); color:#222;
            outline:none; box-shadow:0 3px 8px rgba(0,0,0,0.1);
        }
        textarea { height:340px; resize:vertical; font-family:Consolas,monospace; font-size:14px; line-height:1.45; }
        .controls { display:flex; gap:12px; margin-top:22px; flex-wrap:wrap; }
        .btn {
            flex:1; min-width:200px; padding:14px 20px; border-radius:50px; border:none;
            font-size:16px; font-weight:bold; cursor:pointer; transition:all 0.18s;
            box-shadow:0 4px 14px rgba(0,0,0,0.18);
        }
        .btn-copy   { background:#fff; color:#1e40af; }
        .btn-preview { background:#10b981; color:white; }
        .btn:hover   { transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,0.24); }
        .btn:active  { transform:translateY(1px); }
        .hint { font-size:0.84em; opacity:0.85; margin-top:6px; }
        .example-btn {
            background:rgba(255,255,255,0.22); color:white; border:none;
            padding:6px 12px; border-radius:6px; cursor:pointer; font-size:0.82em;
            margin-left:12px;
        }
        iframe {
            width:100%; height:580px; border:none; border-radius:14px;
            background:white; box-shadow:0 8px 28px rgba(0,0,0,0.32);
        }
        .preview-label { text-align:center; font-weight:bold; margin-bottom:12px; font-size:1.1em; }
    </style>
</head>
<body>

<div class="main-layout">
    <h1>Cr√©ateur de Flashcards Avanc√©</h1>

    <div class="container">
        <label>Titre du deck</label>
        <input type="text" id="title" placeholder="Ex: Thermodynamique ‚Äì L2 Physique">

        <label>
            Contenu (une carte par bloc Q:/A:)
            <button class="example-btn" onclick="loadExample()">Exemple Thermo</button>
        </label>
        <textarea id="content" placeholder="Q: Question ici ?\nA: R√©ponse ici...\n\nQ: Autre question\nA: $$ formule $$"></textarea>
        <div class="hint">Format strict : Q: ‚Ä¶‚ÜµA: ‚Ä¶‚Üµ‚Üµ(ligne vide entre cartes) ‚Äì Supporte LaTeX ($‚Ä¶$ et $$‚Ä¶$$)</div>

        <div class="controls">
            <button class="btn btn-copy"   onclick="copyCode()">üìã Copier HTML</button>
            <button class="btn btn-preview" onclick="updatePreview()">‚Üª Actualiser</button>
        </div>
    </div>

    <div class="preview-container">
        <div class="preview-label">Aper√ßu (fonctionnalit√©s compl√®tes)</div>
        <iframe id="previewFrame" sandbox="allow-scripts"></iframe>
    </div>
</div>

<script>
    let timeout = null;

    function loadExample() {
        document.getElementById('title').value = "Thermodynamique";
        document.getElementById('content').value = 
`Q: D√©finir un syst√®me ouvert et un syst√®me ferm√©.
A: Syst√®me ferm√© : n'√©change que de l'√©nergie. Syst√®me ouvert : √©nergie + mati√®re.

Q: √âquation d'√©tat du gaz parfait ?
A: $$ PV = nRT $$ avec $R = 8,314 \\, \\mathrm{J \\cdot K^{-1} \\cdot mol^{-1}}$

Q: Relation de Mayer ?
A: $$ C_p - C_v = nR $$

Q: Rendement de Carnot ?
A: $$ \\eta = 1 - \\frac{T_\\mathrm{froide}}{T_\\mathrm{chaude}} $$

Q: Premi√®re identit√© thermodynamique ?
A: $$ dU = T\\,dS - P\\,dV $$`;
        updatePreviewSoon();
    }

    function parseCards() {
        const text = document.getElementById('content').value
            .replace(/\r\n/g, '\n')
            .replace(/\n\s*\n+/g, '\n\n') + '\n\n';

        const cards = [];
        const regex = /Q:\s*([\s\S]+?)\nA:\s*([\s\S]+?)(?=\n\s*Q:|$)/gi;
        let match;
        let idCounter = 1;

        while ((match = regex.exec(text)) !== null) {
            const q = match[1].trim();
            const a = match[2].trim();
            if (q && a) {
                cards.push({
                    id: `card-${String(idCounter).padStart(3,'0')}`,
                    q, a
                });
                idCounter++;
            }
        }
        return cards;
    }

    function buildHTML() {
        const title = (document.getElementById('title').value.trim() || "Flashcards").replace(/[<>&"]/g,'');
        const cards = parseCards();

        if (cards.length === 0) {
            return `<body style="display:flex;align-items:center;justify-content:center;min-height:100vh;color:#eee;font-size:1.4em;">Aucune carte valide d√©tect√©e‚Ä¶ V√©rifie le format Q:/A:</body>`;
        }

        const jsonCards = JSON.stringify(cards, null, 2);

        return `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards - ${title}</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#2C75FF,#002FA7);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;overflow-x:hidden;color:white;}
        .container{max-width:900px;width:100%;position:relative;z-index:1;}
        .header{text-align:center;color:white;margin-bottom:25px;}
        .header h1{font-size:2.2em;margin-bottom:8px;text-shadow:0 2px 5px rgba(0,0,0,0.2);}
        .header p{opacity:0.95;}
        .top-panels{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:18px;}
        .panel{background:rgba(255,255,255,0.16);border:1px solid rgba(255,255,255,0.18);border-radius:18px;padding:12px 14px;color:white;backdrop-filter:blur(6px);box-shadow:0 8px 18px rgba(0,0,0,0.15);}
        .panel-row{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;}
        .btn{padding:10px 18px;border-radius:50px;font-weight:700;cursor:pointer;border:none;background:white;color:#2C75FF;box-shadow:0 4px 6px rgba(0,0,0,0.12);transition:transform 0.2s,opacity 0.2s;user-select:none;}
        .btn:active{transform:scale(0.95);}
        .btn.secondary{background:rgba(255,255,255,0.92);color:#0b2a88;}
        .btn.danger{background:rgba(255,255,255,0.92);color:#b91c1c;}
        .btn-know{background:linear-gradient(135deg,#10b981,#059669);color:white;}
        .btn-dontknow{background:linear-gradient(135deg,#f59e0b,#d97706);color:white;}
        .select{border:none;border-radius:50px;padding:10px 14px;font-weight:700;outline:none;cursor:pointer;background:white;color:#2C75FF;box-shadow:0 4px 6px rgba(0,0,0,0.12);}
        .stats{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;font-weight:700;}
        .chip{background:rgba(255,255,255,0.22);border:1px solid rgba(255,255,255,0.2);padding:6px 12px;border-radius:999px;color:white;font-size:14px;}
        .card-scene{perspective:1000px;width:100%;height:450px;cursor:pointer;}
        .card{width:100%;height:100%;position:relative;transition:transform 0.6s cubic-bezier(0.4,0.2,0.2,1);transform-style:preserve-3d;border-radius:25px;box-shadow:0 15px 35px rgba(0,0,0,0.2);}
        .card.is-flipped{transform:rotateY(180deg);}
        .card-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:25px;padding:40px;background:white;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;}
        .card-face.back{transform:rotateY(180deg);background:#fdfdfd;}
        .card-label{position:absolute;top:30px;font-size:13px;font-weight:900;padding:8px 20px;border-radius:20px;color:white;text-transform:uppercase;letter-spacing:1px;}
        .bg-question{background:linear-gradient(135deg,#74D0F1,#0000FF);}
        .bg-answer{background:linear-gradient(135deg,#10b981,#059669);}
        .card-content{font-size:22px;line-height:1.6;color:#333;width:100%;overflow-y:auto;max-height:80%;white-space:pre-line;}
        mjx-container{font-size:110% !important;outline:none;}
        .card-hint{position:absolute;bottom:18px;font-size:14px;color:#aaa;width:100%;text-align:center;}
        .status-pill{position:absolute;top:30px;right:30px;font-size:12px;font-weight:900;padding:8px 12px;border-radius:999px;color:white;text-transform:uppercase;letter-spacing:0.7px;box-shadow:0 8px 18px rgba(0,0,0,0.15);}
        .status-unknown{background:linear-gradient(135deg,#f59e0b,#d97706);}
        .status-known{background:linear-gradient(135deg,#10b981,#059669);}
        .status-unset{background:linear-gradient(135deg,#64748b,#475569);}
        .navigation{display:flex;justify-content:space-between;align-items:center;margin-top:22px;padding:0 10px;}
        .nav-btn{width:50px;height:50px;border-radius:50%;border:none;background:linear-gradient(135deg,#74D0F1,#0000FF);color:white;font-size:20px;cursor:pointer;transition:transform 0.2s;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 10px rgba(0,0,0,0.2);}
        .nav-btn:hover{transform:scale(1.1);}
        .nav-btn:active{transform:scale(0.9);}
        .counter{color:white;font-size:18px;font-weight:700;background:rgba(255,255,255,0.2);padding:5px 15px;border-radius:15px;}
        .progress-bar{margin-top:20px;height:8px;background:rgba(0,0,0,0.2);border-radius:10px;overflow:hidden;}
        .progress-fill{height:100%;background:linear-gradient(90deg,#74D0F1,#0000FF);width:0%;transition:width 0.3s ease-out;}
        .keyboard-hint{text-align:center;color:rgba(255,255,255,0.6);font-size:12px;margin-top:10px;}
        .knowbar{display:flex;gap:12px;justify-content:center;margin-top:18px;flex-wrap:wrap;}
        @media (max-width:520px){.card-face{padding:28px;}.card-content{font-size:19px;}.status-pill{top:20px;right:20px;}}
    </style>
    <script>
    window.MathJax={tex:{inlineMath:[['$','$'],['\\\\(','\\\\)']],displayMath:[['$$','$$'],['\\\\[','\\\\]']]},svg:{fontCache:'global'},startup:{typeset:false}};
    <\/script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"><\/script>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>${title}</h1>
        <p>Flashcards + R√©vision active (localStorage)</p>
    </div>

    <div class="top-panels">
        <div class="panel">
            <div class="panel-row">
                <button class="btn" onclick="window.location.href='index.html'">üè† Accueil</button>
                <button class="btn" onclick="shuffleCards()">üé≤ M√©langer</button>
                <button class="btn secondary" onclick="resetOrder()">‚Ü©Ô∏è Ordre normal</button>
                <button class="btn danger" onclick="resetProgress()">üßπ Reset progr√®s</button>
                <select class="select" id="filterSelect" onchange="applyFilter()">
                    <option value="all">üìö Toutes</option>
                    <option value="review">üü† √Ä revoir</option>
                    <option value="known">üü¢ Ma√Ætris√©es</option>
                </select>
            </div>
        </div>
        <div class="panel">
            <div class="stats" id="statsArea"><span class="chip">Chargement...</span></div>
        </div>
    </div>

    <div class="card-scene" onclick="flipCard()">
        <div class="card" id="cardElement">
            <div class="card-face front">
                <div class="card-label bg-question">Question</div>
                <div class="status-pill status-unset" id="statusPill">Non not√©e</div>
                <div class="card-content" id="questionContent"></div>
                <div class="card-hint">Toucher / Espace / Entr√©e pour retourner</div>
            </div>
            <div class="card-face back">
                <div class="card-label bg-answer">R√©ponse</div>
                <div class="card-content" id="answerContent"></div>
            </div>
        </div>
    </div>

    <div class="knowbar">
        <button class="btn btn-dontknow" onclick="markDontKnow(event)">üü† Je sais pas</button>
        <button class="btn btn-know" onclick="markKnow(event)">üü¢ Je sais</button>
    </div>

    <div class="navigation">
        <button class="nav-btn" onclick="previousCard(event)">‚Üê</button>
        <div class="counter"><span id="currentCard">1</span> / <span id="totalCards">1</span></div>
        <button class="nav-btn" onclick="nextCard(event)">‚Üí</button>
    </div>

    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>

    <div class="keyboard-hint">Fl√®ches : naviguer ‚Ä¢ Espace : retourner ‚Ä¢ 1 = pas ‚Ä¢ 2 = sais</div>
</div>

<script>
const flashcardsData = ${jsonCards};

const LS_KEY_PROGRESS = "${title.toLowerCase().replace(/\\s+/g,'_')}_progress_v1";
const LS_KEY_ORDER    = "${title.toLowerCase().replace(/\\s+/g,'_')}_order_v1";
const LS_KEY_FILTER   = "${title.toLowerCase().replace(/\\s+/g,'_')}_filter_v1";

let baseCards = [...flashcardsData];
let cards = [];
let currentIndex = 0;
let isFlipped = false;

const cardEl = document.getElementById("cardElement");
const statusPill = document.getElementById("statusPill");
const filterSelect = document.getElementById("filterSelect");

function loadProgress(){try{return JSON.parse(localStorage.getItem(LS_KEY_PROGRESS))||{}}catch{return {}}}
function saveProgress(m){localStorage.setItem(LS_KEY_PROGRESS,JSON.stringify(m))}
function loadOrder(){try{return JSON.parse(localStorage.getItem(LS_KEY_ORDER))||null}catch{return null}}
function saveOrder(o){localStorage.setItem(LS_KEY_ORDER,JSON.stringify(o))}
function loadFilter(){return localStorage.getItem(LS_KEY_FILTER)||"all"}
function saveFilter(v){localStorage.setItem(LS_KEY_FILTER,v)}

function setStatusPill(state){
    statusPill.classList.remove("status-known","status-unknown","status-unset");
    if(state==="known"){statusPill.classList.add("status-known");statusPill.textContent="Ma√Ætris√©e";}
    else if(state==="review"){statusPill.classList.add("status-unknown");statusPill.textContent="√Ä revoir";}
    else{statusPill.classList.add("status-unset");statusPill.textContent="Non not√©e";}
}

function getCurrentCard(){return cards[currentIndex];}

function rebuildCardsList(keepIndex=false){
    const progress = loadProgress();
    const filter = filterSelect.value;
    let ordered = [...baseCards];
    const orderIds = loadOrder();
    if(Array.isArray(orderIds)&&orderIds.length===baseCards.length){
        const map = new Map(baseCards.map(c=>[c.id,c]));
        ordered = orderIds.map(id=>map.get(id)).filter(Boolean);
    }
    if(filter==="known") ordered=ordered.filter(c=>progress[c.id]==="known");
    else if(filter==="review") ordered=ordered.filter(c=>progress[c.id]!=="known");
    if(ordered.length===0) ordered=[...baseCards];
    const oldId = keepIndex && cards[currentIndex] ? cards[currentIndex].id : null;
    cards = ordered;
    if(keepIndex && oldId){
        const ni = cards.findIndex(c=>c.id===oldId);
        currentIndex = ni>=0 ? ni : 0;
    } else currentIndex=0;
    updateCardContent();
}

function updateStats(){
    const p = loadProgress();
    const t = baseCards.length;
    const k = baseCards.filter(c=>p[c.id]==="known").length;
    const r = t-k;
    const pct = t===0?0:Math.round(k/t*100);
    document.getElementById("statsArea").innerHTML=\`
        <span class="chip">üü¢ Ma√Ætris√©es : <strong>\${k}</strong> / \${t}</span>
        <span class="chip">üü† √Ä revoir : <strong>\${r}</strong> / \${t}</span>
        <span class="chip">üìä \${pct}%</span>\`;
}

function updateCardContent(){
    if(!cards.length) return;
    const p = loadProgress();
    const c = getCurrentCard();
    document.getElementById("questionContent").innerHTML = c.q;
    document.getElementById("answerContent").innerHTML = c.a;
    setStatusPill(p[c.id] || null);
    document.getElementById("currentCard").textContent = currentIndex+1;
    document.getElementById("totalCards").textContent = cards.length;
    document.getElementById("progressFill").style.width = ((currentIndex+1)/cards.length*100)+"%";
    updateStats();
    if(window.MathJax) MathJax.typesetPromise();
}

function flipCard(){isFlipped=!isFlipped; cardEl.classList.toggle("is-flipped",isFlipped);}

function nextCard(e){if(e)e.stopPropagation(); isFlipped=false; cardEl.classList.remove("is-flipped");
    setTimeout(()=>{currentIndex=(currentIndex+1)%cards.length; updateCardContent();},180);}
function previousCard(e){if(e)e.stopPropagation(); isFlipped=false; cardEl.classList.remove("is-flipped");
    setTimeout(()=>{currentIndex=(currentIndex-1+cards.length)%cards.length; updateCardContent();},180);}

function shuffleCards(){
    isFlipped=false; cardEl.classList.remove("is-flipped");
    setTimeout(()=>{
        const ids=[...baseCards.map(c=>c.id)];
        ids.sort(()=>Math.random()-0.5);
        saveOrder(ids);
        rebuildCardsList(false);
    },220);
}

function resetOrder(){localStorage.removeItem(LS_KEY_ORDER); rebuildCardsList(false);}
function resetProgress(){if(!confirm("Supprimer tout progr√®s ?"))return; localStorage.removeItem(LS_KEY_PROGRESS); rebuildCardsList(true);}

function markKnow(e){if(e)e.stopPropagation();
    const p=loadProgress(); p[getCurrentCard().id]="known"; saveProgress(p);
    updateCardContent(); setTimeout(nextCard,140);}
function markDontKnow(e){if(e)e.stopPropagation();
    const p=loadProgress(); p[getCurrentCard().id]="review"; saveProgress(p);
    updateCardContent(); setTimeout(nextCard,140);}

function applyFilter(){saveFilter(filterSelect.value); rebuildCardsList(false);}

document.addEventListener('keydown',e=>{
    if(e.key==='ArrowRight')nextCard();
    if(e.key==='ArrowLeft')previousCard();
    if(e.key===' '||e.key==='Enter'){e.preventDefault();flipCard();}
    if(e.key==='1')markDontKnow();
    if(e.key==='2')markKnow();
});

let tsX=0; const scene=document.querySelector('.card-scene');
scene.addEventListener('touchstart',e=>{tsX=e.changedTouches[0].screenX;});
scene.addEventListener('touchend',e=>{let teX=e.changedTouches[0].screenX;
    if(tsX-teX>60)nextCard(); if(teX-tsX>60)previousCard();});

(function init(){
    filterSelect.value=loadFilter();
    rebuildCardsList(false);
})();
<\/script>
</body>
</html>`;
    }

    function copyCode() {
        const html = buildHTML();
        if (html.includes("Aucune carte valide")) {
            alert("Aucune carte valide. V√©rifie le format Q: ‚Ä¶ A: ‚Ä¶");
            return;
        }
        navigator.clipboard.writeText(html)
            .then(()=>alert("Code copi√© ! Colle-le dans un fichier .html"))
            .catch(()=>alert("Copie impossible ‚Äì s√©lectionne manuellement."));
    }

    function updatePreview() {
        clearTimeout(timeout);
        document.getElementById('previewFrame').srcdoc = buildHTML();
    }

    function updatePreviewSoon() {
        clearTimeout(timeout);
        timeout = setTimeout(updatePreview, 1200);
    }

    document.getElementById('content').addEventListener('input', updatePreviewSoon);
    document.getElementById('title').addEventListener('input', updatePreviewSoon);

    setTimeout(updatePreview, 600);
</script>
</body>
</html>
